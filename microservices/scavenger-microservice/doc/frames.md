# Frames

This document describes the frames exchanged between the mobile client and the microservice as well as the protocol used for the interactions.

Each frame is identified by its type (`type` attribute). The `type` attribute is required for all frames.

## Connection frame

When the mobile client starts, it connects to the `/game` web socket. Once connected, the mobile client sends the following frame:

```json
{ "type": "connection" }
```

If the mobile client stored a `PlayerId` (UUID of the player), the frame is extended with the `playerId` attribute:

```json
{ "type": "connection", "playerId": "$uuid" }
```

## Configuration frame

As a response to the _connection frame_, a _configuration frame_ is sent by the microservice to the mobile application.

```json
{
  "type":"configuration",
  "playerId":"b180717d-ebb1-462f-bfe6-d4f257705802",
  "username":"Phase Carver",
  "data-center":"AWS",
  "score": "the player score, 0 if it's the first connection",
  "party": true|false,
  "game": true|false,
  "tasks":{
    "ee95d096-5e9a-4d4a-bcac-488d6436e47f":{
      "description":"Red Hat logo","type":"map","stage":1
    },
    "0117da38-116d-4ad1-a6c5-e7c834d01b19":{
      "description":"Bicycle","type":"map","stage":2
    },
    "5e88020e-02be-4d70-88a1-b432d0114b3f":{
      "description":"Galder's dog","type":"partyisland"
    }
  },
  "achievements": [
    {
      "taskId": "achieved task",
      "point": 23,
      "transactionId": "the tx id to avoid replay"
    }
  ]
}
```

This configuration frame contains the _playerId_ (to store), the username, the name of the data center and the list of tasks.

It also gives the current score of the user (`score`) and the list of completed achievements. Each achievement contains
the associated task id, the transaction id and the number of point that has been scored for this task.

The configuration frame contains the `party` and `game` flag indicating if the _party island_ mode is enabled or disabled, and if the game is running (true) or paused (false).

## The picture frame

The `picture` frame is sent by the mobile application to the microservice to send a picture to the server.

```json
{
  "type":"picture",
  "transactionId": "${UUID}",
  "playerId": "${playerId}",
  "taskId": "${taskId}",
  "picture": "${picture base64 encoded}",
  "metadata": {
    "format":"jpg"
  }
}
```

The `transactionId` is a unique id generated by the application that is used to track the request.

The `playerId` and `taskId` identifies respectively the player and the task.

The `picture` is the content of the picture encoded using base64.

The `metadata` is a JSON object containing any metadata sent by the application.

## Score frame

After a picture frame, a `score` frame is sent:

```json
{
  "type": "score",
  "playerId": "${playerId}",
  "transactionId": "${transactionId}",
  "score": 23,
  "taskId": "${taskId}",
  "total": 123,
  "scored": true,
  "matched": true,
  "achievements": [
    {
      "taskId": "achieved task",
      "point": 23,
      "transactionId": "the tx id to avoid replay"
    }
  ]
}
```

Some fields of the score frame are important:

* `scored` : a boolean indicating if the transaction has successfully increase the score of the player. There are several
reason while if would be false: the picture does not match the task, the achievement has already been achieved.
* `score` : the score for this particular transaction, 0 is `scored` is false
* `total` : the current player score
* `achievements`: the achievement of the player. If this transaction scored, then the associated achievement has been
added to the list.
* `matched` : whether or not the picture matches 

the list of completed achievements. Each achievement contains
the associated task id, the transaction id and the number of point that has been scored for this task.  

## Ping frame   

On AWS, the web socket connection are closed after 60 seconds if both parties are not exchanging data periodically. To avoid being cut, the microservice and the mobile application must send `ping` frame periodically:

```json
{ "type": "ping"}
```

The microservice is sending `ping` frames to all connected client every 20 seconds.

## Error frame

If something wrong happen, especially after a `picture` frame, an error frame is sent to the client:

```json
{
  "type": "error",
  "status": 500,
  "message": "some message",
  "transactionId": "if known the transactionId"
}
```

An error frame is also sent to the client if ths client attempts to upload a pciture while the game is paused.

## Admin frames

These frames needs to be sent to the `/admin` web socket:

```json
{
  "type":"party-island",
  "token": "the_token",
  "enabled": "true" | "false"
}

{
  "type":"game",
  "token": "the_token",
  "state": "lobby" | "play" | "pause" | "game-over"
}
```


The token can be found in the microservice configuration
